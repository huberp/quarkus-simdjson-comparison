name: Performance Comparison

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Start Quarkus server
      run: |
        java --add-modules jdk.incubator.vector -jar target/quarkus-app/quarkus-run.jar > server.log 2>&1 &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        echo "Started server with PID: $SERVER_PID"
        
    - name: Wait for server to be ready
      run: |
        echo "Waiting for server to start..."
        for i in {1..30}; do
          if curl -s http://localhost:8080 > /dev/null 2>&1; then
            echo "Server is ready!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done
        
        # Verify server is responding
        if ! curl -s http://localhost:8080 > /dev/null 2>&1; then
          echo "Server failed to start!"
          cat server.log
          exit 1
        fi
        
    - name: Run load test - Plain Quarkus (Jackson)
      run: |
        chmod +x .github/loadtest.sh
        .github/loadtest.sh "/user/standard" "Plain Quarkus (Jackson)" 1000
        
    - name: Run load test - SimdJSON
      run: |
        .github/loadtest.sh "/user/simdjson" "SimdJSON" 1000
        
    - name: Generate comparison summary
      if: always()
      run: |
        if [ -f loadtest_results.csv ]; then
          echo "## Performance Comparison Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Implementation | Endpoint | Iterations | Total Time (ms) | Avg Response (ms) |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|----------|------------|-----------------|-------------------|" >> $GITHUB_STEP_SUMMARY
          while IFS=',' read -r name endpoint iterations total_ms avg_ms; do
            echo "| $name | \`$endpoint\` | $iterations | $total_ms | $avg_ms |" >> $GITHUB_STEP_SUMMARY
          done < loadtest_results.csv
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload load test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: loadtest-results
        path: |
          loadtest_results.csv
          server.log
        
    - name: Stop server
      if: always()
      run: |
        if [ -n "$SERVER_PID" ]; then
          echo "Stopping server (PID: $SERVER_PID)"
          kill $SERVER_PID || true
          sleep 2
        fi
